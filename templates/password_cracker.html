{% extends 'dashboard.html' %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Password Cracker Simulation</h2>

  <form method="POST" id="crackerForm" onsubmit="startCrack(event)">
    <input type="text" name="password" id="passwordInput" placeholder="Enter password" required class="form-control mb-3">
    <button type="submit" class="btn btn-primary">Simulate Crack</button>
  </form>

  <div class="mt-4 d-none" id="resultBox">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Estimated Crack Times</h5>
        <ul>
          <li><strong>CPU (1M/sec):</strong> <span id="cpuTime"></span></li>
          <li><strong>GPU (100M/sec):</strong> <span id="gpuTime"></span></li>
          <li><strong>ASIC (1B/sec):</strong> <span id="asicTime"></span></li>
        </ul>

        <h5 class="mt-3">Brute Force Simulation</h5>
        <p><strong>Elapsed Time:</strong> <span id="crackTimer">0.00</span> seconds</p>
        <div class="progress mb-3">
          <div id="crackProgress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0"
            aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <pre id="bruteLog" style="background: #111; color: lime; padding: 1em; max-height: 200px; overflow-y: auto;"></pre>
        <button class="btn btn-secondary mt-3" onclick="downloadLog()">Download Log as CSV</button>
      </div>
    </div>
  </div>
</div>

<script>
const wordlist = [
  "password", "123456", "qwerty", "letmein", "admin", "welcome",
  "pass123", "12345678", "1234", "abc123", "iloveyou", "000000"
];

let attemptLog = [];

function estimateCrackTime(password, rate) {
  let charsetSize = 0;
  if (/[a-z]/.test(password)) charsetSize += 26;
  if (/[A-Z]/.test(password)) charsetSize += 26;
  if (/\d/.test(password)) charsetSize += 10;
  if (/[^A-Za-z0-9]/.test(password)) charsetSize += 32;

  const totalCombos = Math.pow(charsetSize || 1, password.length);
  const seconds = totalCombos / rate;
  return formatTime(seconds);
}

function formatTime(seconds) {
  if (seconds < 1) return "< 1 sec";
  if (seconds < 60) return `${Math.round(seconds)} sec`;
  if (seconds < 3600) return `${Math.round(seconds / 60)} min`;
  if (seconds < 86400) return `${Math.round(seconds / 3600)} hr`;
  if (seconds < 31536000) return `${Math.round(seconds / 86400)} days`;
  return `${Math.round(seconds / 31536000)} yrs`;
}

function* bruteForceGenerator(charset, maxLen) {
  function* helper(prefix, length) {
    if (length === 0) yield prefix;
    else for (let c of charset) yield* helper(prefix + c, length - 1);
  }
  for (let len = 1; len <= maxLen; len++) yield* helper("", len);
}

function startCrack(event) {
  event.preventDefault();
  const password = document.getElementById("passwordInput").value;
  document.getElementById("resultBox").classList.remove("d-none");

  document.getElementById("cpuTime").textContent = estimateCrackTime(password, 1e6);
  document.getElementById("gpuTime").textContent = estimateCrackTime(password, 1e8);
  document.getElementById("asicTime").textContent = estimateCrackTime(password, 1e9);

  const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;':,.<>?";
  const maxLen = password.length;
  const gen = bruteForceGenerator(charset, maxLen);
  const log = document.getElementById("bruteLog");
  const progress = document.getElementById("crackProgress");
  const timerEl = document.getElementById("crackTimer");

  let found = false;
  let tries = 0;
  let maxTries = Math.pow(charset.length, password.length);
  let startTime = performance.now();

  attemptLog = [["Attempt #", "Guess"]]; // reset and add header
  log.innerText = "Starting...\n";

  let elapsedInterval = setInterval(() => {
    const now = performance.now();
    const seconds = ((now - startTime) / 1000).toFixed(2);
    timerEl.textContent = seconds;
  }, 100);

  function step() {
    const t0 = performance.now();
    while (performance.now() - t0 < 50 && !found) {
      const { value, done } = gen.next();
      if (done) break;
      tries++;
      attemptLog.push([tries, value]);
      if (tries % 500 === 0) log.innerText += `Tried: ${value}\n`;
      if (value === password) {
        found = true;
        log.innerText += `✅ Cracked: ${value} in ${tries} tries.\n`;
        progress.style.width = "100%";
        progress.textContent = "100%";
        clearInterval(elapsedInterval);
        return;
      }
    }

    const percent = Math.min(100, Math.round((tries / maxTries) * 100));
    progress.style.width = percent + "%";
    progress.setAttribute("aria-valuenow", percent);
    progress.textContent = percent + "%";

    if (!found) setTimeout(step, 50);
  }

  setTimeout(step, 50);
}

function downloadLog() {
  if (attemptLog.length <= 1) {
    alert("No attempts recorded.");
    return;
  }

  const password = document.getElementById("passwordInput").value.trim();
  const safePassword = password.replace(/[^a-zA-Z0-9_-]/g, "_"); // sanitize
  const filename = `${safePassword}_crack_attempts.csv`;

  // Build CSV
  let csv = "Attempt #,Guess\n";
  attemptLog.slice(1).forEach(row => {
    csv += row.join(",") + "\n";
  });

  // === 1. Download to user's machine ===
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  // === 2. Save to server ===
  fetch("/save-log", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      csv: csv,
      password: password
    })
  })
    .then(res => res.json())
    .then(data => {
      console.log("✅ Server saved:", data.message);
    })
    .catch(err => {
      console.error("❌ Failed to save log on server:", err);
    });
}


</script>
{% endblock %}
